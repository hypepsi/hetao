# 双轨时间系统说明文档

## 概述
"小核桃"应用使用**双轨时间系统**来满足不同的统计需求。

---

## A轨：自然日历逻辑（Natural Calendar）

### 换日点
**北京时间 00:00**（自然日）

### 用途
- 计算宝宝的**出生天数**
- 计算宝宝的**月龄**（X个月 + X周 + X天）
- 显示"已出生X天"

### 实现函数
- `getBabyAge()` - 获取天数/周数
- `getDetailedBabyAge()` - 获取详细年龄（月+周+天）

### 核心逻辑
```typescript
// 只要过了半夜 12 点，宝宝的"出生天数"必须立即 +1
const todayStart = new Date(beijingNow)
todayStart.setHours(0, 0, 0, 0)  // 00:00:00
```

### 示例
- 宝宝出生日期：2025-12-01
- 当前时间：2025-12-10 23:59（北京时间）
- 出生天数：10天
- 当前时间：2025-12-11 00:01（北京时间）
- 出生天数：11天（立即+1）

---

## B轨：医院统计逻辑（Hospital Stats）

### 换日点
**北京时间 06:00**

### 用途
- 统计"**今日喂奶量**"
- 统计"**今日大便次数**"
- 生成"**历史趋势图**"
- 计算"**每日喂养统计**"

### 实现函数
- `getTodayStart()` - 获取今日统计起始时间（返回UTC）
- `getStatsDate(recordTime)` - 获取记录所属的统计日期

### 核心逻辑
```typescript
// 如果当前时间 < 06:00，属于"昨天统计日"
// 如果当前时间 >= 06:00，属于"今天统计日"
if (beijingNow.getHours() < 6) {
  todayStartBeijing.setDate(todayStartBeijing.getDate() - 1)
}
```

### 示例：统计日归属

#### 场景1：正常时段
```
记录时间: 2025-12-10 08:00（北京时间）
小时数: 8 >= 6
归属统计日: 2025-12-10
统计区间: 2025-12-10 06:00 - 2025-12-11 06:00
```

#### 场景2：凌晨时段（关键）
```
记录时间: 2025-12-11 02:35（北京时间）
小时数: 2 < 6
归属统计日: 2025-12-10（前一天）
统计区间: 2025-12-10 06:00 - 2025-12-11 06:00
```

#### 场景3：换日临界点
```
记录时间: 2025-12-11 05:59（北京时间）
小时数: 5 < 6
归属统计日: 2025-12-10

记录时间: 2025-12-11 06:00（北京时间）
小时数: 6 >= 6
归属统计日: 2025-12-11
```

---

## 实际应用场景

### 场景：首页"今日喂养"统计

**当前时间**：2025-12-11 08:00（北京时间）

**统计范围**：
- 起始：2025-12-11 06:00
- 结束：当前时间（08:00）
- 计入记录：所有在 06:00-08:00 之间的喂养

**不计入**：
- 2025-12-11 05:30 的记录（归属前一天）
- 2025-12-11 02:00 的记录（归属前一天）

### 场景：历史统计列表

**查看"2025-12-10"统计日**：

**统计范围**：
- 起始：2025-12-10 06:00
- 结束：2025-12-11 06:00

**计入记录**：
- ✅ 2025-12-10 08:00
- ✅ 2025-12-10 23:00
- ✅ 2025-12-11 02:30（凌晨，<6点）
- ✅ 2025-12-11 05:45（凌晨，<6点）

**不计入**：
- ❌ 2025-12-10 05:30（归属前一天）
- ❌ 2025-12-11 06:30（归属当天）

---

## 函数说明

### `getTodayStart(): Date`
**用途**: 获取今日统计的起始时间（UTC）

**返回值**: UTC时间的Date对象

**应用**: 
- 首页今日统计查询
- 趋势图数据查询

**示例**：
```typescript
// 当前时间: 2025-12-11 08:00（北京时间）
const start = getTodayStart()
// 返回: 2025-12-10T22:00:00.000Z（对应北京时间 12月11日 06:00）

// 当前时间: 2025-12-11 02:00（北京时间）
const start = getTodayStart()
// 返回: 2025-12-09T22:00:00.000Z（对应北京时间 12月10日 06:00）
```

### `getStatsDate(recordTime): string`
**用途**: 获取记录所属的统计日期

**参数**: 记录时间（Date对象）

**返回值**: 统计日期字符串（YYYY-MM-DD）

**应用**: 
- 历史统计数据分组
- 确保每条记录归属正确的统计日

**示例**：
```typescript
// 记录时间: 2025-12-11 05:30（北京时间）
const statsDate = getStatsDate(recordTime)
// 返回: "2025-12-10"（归属前一天）

// 记录时间: 2025-12-11 06:30（北京时间）
const statsDate = getStatsDate(recordTime)
// 返回: "2025-12-11"（归属当天）
```

---

## 数据一致性验证

### 验证点1：首页和历史页面统计一致
**测试方法**：
1. 查看首页"今日喂养统计"的次数（例如：2次）
2. 点击"历史"按钮，查看今天的统计
3. 验证：两个地方的次数应该完全一致

**原因**：
- 首页使用 `getTodayStart()` 查询
- 历史页面使用 `getStatsDate()` 分组
- 两者都是B轨逻辑（06:00换日）

### 验证点2：凌晨记录归属正确
**测试方法**：
1. 在凌晨2点（<6点）添加一条喂养记录
2. 查看首页"今日"统计 - 应该**不包含**这条记录
3. 查看历史页面"昨天"统计 - 应该**包含**这条记录

### 验证点3：6点换日临界点
**测试方法**：
1. 在早上5:59添加记录 → 归属昨天
2. 在早上6:00添加记录 → 归属今天
3. 两条记录应该分别出现在不同的统计日

---

## 常见问题 (FAQ)

### Q1: 为什么要用两套时间系统？
**A**: 
- **A轨（自然日）**：符合日常认知，宝宝年龄按自然日计算
- **B轨（医院统计）**：符合医疗习惯，凌晨的喂养归属前一天，方便统计24小时周期

### Q2: 6点换日会不会造成混淆？
**A**: 
- 对用户透明：用户只看到"今日"/"昨日"等标签
- 实际体验：凌晨喂养本来就是"夜奶"，归到前一天更符合直觉
- 医疗标准：大部分医院也采用类似逻辑

### Q3: 如何确保数据一致性？
**A**: 
- 所有喂养/排便相关统计**必须**使用B轨函数
- `getTodayStart()` 用于查询"今日"数据
- `getStatsDate()` 用于历史数据分组
- 严格区分用途，避免混用

### Q4: 新增功能应该用哪个轨道？
**A**: 
- 如果是"年龄/天数/生长曲线" → 使用A轨（00:00换日）
- 如果是"喂养/排便/统计分析" → 使用B轨（06:00换日）

---

## 代码检查清单

当你添加新的统计功能时，请检查：

✅ **时间分组**
- [ ] 使用 `getStatsDate()` 而非 `format(date, 'yyyy-MM-dd')`
- [ ] 理解06:00换日逻辑

✅ **时区处理**
- [ ] 使用 `toZonedTime` 转换为北京时间
- [ ] 使用 `fromZonedTime` 转换为UTC（存储时）

✅ **查询条件**
- [ ] "今日"查询使用 `getTodayStart()`
- [ ] 不要使用自然日的00:00作为起点

✅ **数据一致性**
- [ ] 首页和历史页面使用相同的分组逻辑
- [ ] 验证凌晨记录的归属

---

## 修复验证

### 修复前
```
首页显示: 今日2次
历史页面今天: 4次  ❌ 不一致
原因: 历史页面把6点前的2条记录也算进来了
```

### 修复后
```
首页显示: 今日2次
历史页面今天: 2次  ✅ 一致
原因: 都使用B轨逻辑（06:00换日）
```

### 验证步骤
1. 刷新浏览器
2. 查看首页"今日喂养统计"次数
3. 点击"历史"查看今天的统计
4. 两个数字应该完全一致

---

## 总结

✅ **双轨时间系统**已完整实现
✅ **B轨分组逻辑**已修复（使用 `getStatsDate()`）
✅ **数据一致性**已保证（首页=历史页面）
✅ **时区处理**统一使用北京时间

所有喂养统计功能现在都严格遵循06:00换日的医院统计逻辑！





